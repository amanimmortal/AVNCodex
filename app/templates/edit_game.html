{% extends "base.html" %}

{% block title %}Edit {{ game.name }} - AVN Codex{% endblock %}

{% block main_content %}
<div class="container">

    {# Header Section #}
    <div class="game-header-section">
        <div>
            <h1 class="game-title">{{ game.name }}</h1>
            <div class="game-meta-tags">
                <span class="badge status-{{ game.completed_status|lower|replace(' ', '_') }}"
                    title="Game Status">Status: {{ game.completed_status or 'Unknown' }}</span>
                <span class="badge badge-secondary" title="Current Version">{{ game.version or 'v?' }}</span>
                {% if game.engine %}
                <span class="badge badge-secondary" title="Game Engine">{{ game.engine }}</span>
                {% endif %}
            </div>
        </div>
        <div>
            <a href="{{ game.f95_url }}" target="_blank" class="btn btn-primary">
                <i class="bi bi-box-arrow-up-right"></i> Visit F95Zone
            </a>
        </div>
    </div>
</div>

<div class="details-grid">
    {# Left Column: Main Content (Desc + Downloads) #}
    <div class="main-column">

        {# Description #}
        <h3 class="text-accent mb-3">Overview</h3>
        <div class="description-box mb-4">
            {{- game.description.replace('Overview:', '').strip() if game.description and game.description not in
            ['Not found', 'Not yet scraped'] else 'No description available.' -}}
        </div>

        {# Download Links #}
        <h3 class="text-accent mb-3">Downloads</h3>
        <div class="download-section">
            {% if game.download_links and game.download_links is iterable and game.download_links[0].text != 'Error
            decoding download links' and game.download_links[0].text != 'Not found' %}

            {% set os_labels = {'win': 'Windows', 'mac': 'Mac', 'linux': 'Linux', 'android': 'Android', 'extras':
            'Extras', 'unknown': 'Other'} %}
            {% set os_icons = {'win': 'bi-windows', 'mac': 'bi-apple', 'linux': 'bi-ubuntu', 'android':
            'bi-android', 'extras': 'bi-collection', 'unknown': 'bi-file-earmark'} %}
            {% set os_order = ['win', 'mac', 'linux', 'android', 'extras', 'unknown'] %}

            {% for os_code in os_order %}
            {# Check if links exist for this OS #}
            {% set ns = namespace(found=false) %}
            {% for link in game.download_links %}
            {% if link.os_type == os_code %}
            {% set ns.found = true %}
            {% endif %}
            {% endfor %}

            {% if ns.found %}
            <div class="download-group">
                <div class="download-group-header">
                    <i class="bi {{ os_icons[os_code] }}"></i> {{ os_labels[os_code] }}
                </div>
                <div class="download-links-container">
                    {% for link in game.download_links %}
                    {% if link.os_type == os_code %}
                    <a href="{{ link.url }}" target="_blank" class="download-link-btn">
                        <i class="bi bi-cloud-arrow-down-fill"></i> {{ link.text }}
                    </a>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {% else %}
            <div class="alert alert-secondary">No download links available.</div>
            {% endif %}
        </div>

        {# Tags #}
        <h4 class="text-white mt-4 mb-2">Tags</h4>
        <div class="d-flex flex-wrap gap-2 mb-4">
            {% if game.tags and game.tags is iterable and game.tags[0] != 'Not found' %}
            {% for tag in game.tags %}
            <span class="badge badge-secondary">{{ tag }}</span>
            {% endfor %}
            {% else %}
            <span class="text-muted">No tags.</span>
            {% endif %}
        </div>

    </div>

    {# Right Column: Sidebar (Info + Actions) #}
    <div class="sidebar-column">

        {# Game Info Block #}
        <div class="info-block">
            <h4 class="text-accent mb-3">Game Info</h4>
            <div class="mb-2"><strong>Author:</strong> <span class="text-secondary">{{ game.author or 'N/A'
                    }}</span></div>
            <div class="mb-2"><strong>Language:</strong> <span class="text-secondary">{{ game.language or 'N/A'
                    }}</span></div>
            <div class="mb-2"><strong>Censorship:</strong> <span class="text-secondary">{{ game.censorship or 'N/A'
                    }}</span></div>
            <hr style="border-color: var(--border-color);">
            <div class="mb-2"><small class="text-muted">Last Update: {{ game.rss_pub_date or 'N/A' }}</small></div>
            <div class="mb-2"><small class="text-muted">Scraped: {{ game.scraper_last_run_at or 'Never' }}</small>
            </div>
            {# Force Update Button for Debug #}
            <form action="{{ url_for('manual_sync_game', played_game_id=game.played_game_id) }}" method="POST"
                class="mt-2">
                <button type="submit" class="btn btn-sm btn-outline-warning w-100">Force Update Data</button>
            </form>
        </div>

        {# User Actions Block #}
        <div class="info-block">
            <h4 class="text-accent mb-3">Your Tracking</h4>
            <form method="POST" action="{{ url_for('edit_game', played_game_id=game.played_game_id) }}">

                <div class="mb-3">
                    <label for="user_rating" class="form-label">Rating</label>
                    <select class="form-select" id="user_rating" name="user_rating">
                        <option value="" {% if game.user_rating is none %}selected{% endif %}>Not Rated</option>
                        <option value="5" {% if game.user_rating==5 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Masterpiece)
                        </option>
                        <option value="4" {% if game.user_rating==4 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê (Great)</option>
                        <option value="3" {% if game.user_rating==3 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê (Good)</option>
                        <option value="2" {% if game.user_rating==2 %}selected{% endif %}>‚≠ê‚≠ê (Fair)</option>
                        <option value="1" {% if game.user_rating==1 %}selected{% endif %}>‚≠ê (Poor)</option>
                        <option value="0" {% if game.user_rating==0 %}selected{% endif %}>üí© (Awful)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="user_notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="user_notes" name="user_notes" rows="5"
                        placeholder="Private notes...">{{ game.user_notes if game.user_notes is not none else '' }}</textarea>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" class="form-check-input" id="notify_for_updates" name="notify_for_updates" {%
                        if game.notify_for_updates %}checked{% endif %}>
                    <label class="form-check-label" for="notify_for_updates">Notify on Update</label>
                </div>

                <button type="submit" class="btn btn-primary w-100 mb-2">Save Changes</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">Back</a>
            </form>
        </div>

    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}