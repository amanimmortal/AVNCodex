{% extends "base.html" %}

{% block title %}{{ title_override|default('Edit Details for ' ~ game.name) }} - AVN Codex{% endblock %}

{% block main_content %}
<div class="container mt-4 mb-5"> {# Added mb-5 for more bottom space #}
    <div class="row">
        <div class="col-md-8 offset-md-2"> {# Centered and slightly wider content area #}
            <h2 class="mb-4">Game Details: {{ game.name }}</h2>

            {# Display Core Game Info (Read-Only) #}
            <div class="card mb-4">
                <div class="card-header">
                    Core Information
                </div>
                <div class="card-body">
                    <p><strong>Title:</strong> {{ game.name | default('N/A') }}</p>
                    <p><strong>F95zone URL:</strong> <a href="{{ game.f95_url }}" target="_blank">{{ game.f95_url }}</a>
                    </p>
                    <p><strong>Original Author/Thread Starter:</strong> {{ game.author | default('N/A') }}</p>
                    <p><strong>Latest Version (from RSS/Manual Sync):</strong> {{ game.version | default('N/A') }}</p>
                    <p><strong>Last Update Detected (RSS):</strong> {{ game.rss_pub_date | default('N/A') }}</p>
                    <p><strong>Date Added to Your List:</strong> {{ game.date_added_to_played_list.split('T')[0] if
                        game.date_added_to_played_list else 'N/A' }}</p>
                </div>
            </div>

            {# Display Scraped Information (Read-Only) #}
            <div class="card mb-4">
                <div class="card-header">
                    Scraped Details (Last Scraped: {{ game.scraper_last_run_at | default('Never') }})
                </div>
                <div class="card-body">
                    <p><strong>Engine:</strong> {{ game.engine | default('Not available') }}</p>
                    <p><strong>Language:</strong> {{ game.language | default('Not available') }}</p>
                    <p><strong>Status:</strong> {{ game.status | default('Not available') }}</p> {# This should be the
                    scraped status #}
                    <p><strong>Censorship:</strong> {{ game.censorship | default('Not available') }}</p>

                    <h5 class="mt-3">Tags:</h5>
                    {% if game.tags and game.tags is iterable and game.tags[0] != 'Not found' and game.tags[0] != 'Error
                    decoding tags' %}
                    <div class="d-flex flex-wrap gap-1">
                        {% for tag in game.tags %}
                        <span
                            class="badge rounded-pill bg-secondary bg-opacity-75 text-white border border-secondary">{{
                            tag }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted fst-italic">{{ game.tags[0] if game.tags and game.tags is iterable else 'No
                        tags available.' }}</p>
                    {% endif %}

                    <h5 class="mt-3">Description:</h5>
                    {% if game.description and game.description not in ['Not found', 'Not yet scraped'] %}
                    <div class="game-description p-3 rounded shadow-sm"
                        style="max-height: 250px; overflow-y: auto; white-space: pre-wrap; background-color: #212529; color: #f8f9fa; border: 1px solid #343a40; font-size: 0.95rem;">
                        {{ game.description }}
                    </div>
                    {% else %}
                    <p class="text-muted">{{ game.description | default('Not available') }}</p>
                    {% endif %}


                    <h5 class="mt-4">Download Links:</h5>
                    {% if game.download_links and game.download_links is iterable and game.download_links[0].text !=
                    'Error decoding download links' and game.download_links[0].text != 'Not found' %}

                    {% set os_labels = {'win': 'Windows', 'mac': 'Mac', 'linux': 'Linux', 'android': 'Android',
                    'extras': 'Extras', 'unknown': 'Other'} %}
                    {% set os_order = ['win', 'mac', 'linux', 'android', 'extras', 'unknown'] %}

                    <div class="ms-2">
                        {% for os_code in os_order %}
                        {# Check if any links exist for this OS #}
                        {% set ns = namespace(found=false) %}
                        {% for link in game.download_links %}
                        {% if link.os_type == os_code %}
                        {% set ns.found = true %}
                        {% endif %}
                        {% endfor %}

                        {% if ns.found %}
                        <h6 class="text-uppercase text-secondary fw-bold mt-2"
                            style="font-size: 0.8rem; letter-spacing: 0.5px;">{{ os_labels[os_code] }}</h6>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            {% for link in game.download_links %}
                            {% if link.os_type == os_code %}
                            <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-primary shadow-sm"
                                style="min-width: 100px;">
                                <i class="bi bi-download me-1"></i> {{ link.text }}
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                    {% else %}
                    <p class="text-muted fst-italic">{{ 'No download links available.' }}</p>
                    {% endif %}
                </div>
            </div>

            {# User Editable Fields #}
            <div class="card">
                <div class="card-header">
                    Your Personal Tracking
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_game', played_game_id=game.played_game_id) }}">
                        <div class="mb-3">
                            <label for="user_notes" class="form-label">Your Notes:</label>
                            <textarea class="form-control" id="user_notes" name="user_notes"
                                rows="6">{{ game.user_notes if game.user_notes is not none else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="user_rating" class="form-label">Your Rating:</label>
                            <select class="form-select" id="user_rating" name="user_rating" style="max-width: 200px;">
                                <option value="" {% if game.user_rating is none %}selected{% endif %}>Not Rated</option>
                                <option value="0" {% if game.user_rating==0 %}selected{% endif %}>0 Stars (Worst)
                                </option>
                                <option value="1" {% if game.user_rating==1 %}selected{% endif %}>1 Star</option>
                                <option value="2" {% if game.user_rating==2 %}selected{% endif %}>2 Stars</option>
                                <option value="3" {% if game.user_rating==3 %}selected{% endif %}>3 Stars</option>
                                <option value="4" {% if game.user_rating==4 %}selected{% endif %}>4 Stars</option>
                                <option value="5" {% if game.user_rating==5 %}selected{% endif %}>5 Stars (Best)
                                </option>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="notify_for_updates"
                                name="notify_for_updates" {% if game.notify_for_updates %}checked{% endif %}>
                            <label class="form-check-label" for="notify_for_updates">Notify me about updates for this
                                game</label>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to List</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
    .game-description {
        font-size: 0.9rem;
        background-color: #f8f9fa;
        /* A light background for these text areas */
        border: 1px solid #e9ecef;
    }
</style>
{% endblock %}